import network
import socket
import time

SSID = "Pico_AP"
PASSWORD = "12345678"
SERVER_IP = "192.168.4.1"
SERVER_PORT = 8080

def connect_wifi(ssid, password):
    sta = network.WLAN(network.STA_IF)
    if not sta.active():
        sta.active(True)
    
    if not sta.isconnected():
        print("üîå Conectando a la red WiFi...")
        sta.connect(ssid, password)
        while not sta.isconnected():
            time.sleep(1)
    print("‚úÖ Conectado al AP:", sta.ifconfig()[0])
    return sta

def connect_to_server(ip, port):
    s = socket.socket()
    try:
        s.connect((ip, port))
        print("üîó Conectado al servidor TCP")
        return s
    except OSError as e:
        print("‚ùå Error al conectar con el servidor:", e)
        s.close()
        return None

sta = connect_wifi(SSID, PASSWORD)
time.sleep(2)  # Tiempo para estabilizar conexi√≥n

sock = connect_to_server(SERVER_IP, SERVER_PORT)

while True:
    if not sta.isconnected():
        print("‚ö†Ô∏è Conexi√≥n WiFi perdida. Reconectando...")
        sta = connect_wifi(SSID, PASSWORD)
        time.sleep(2)
        sock = connect_to_server(SERVER_IP, SERVER_PORT)

    try:
        data = sock.recv(1024)
        if data:
            print("üì• Datos recibidos:", data.decode())
    except OSError as e:
        print("‚ö†Ô∏è Error de socket:", e)
        print("üîÅ Intentando reconectar al servidor...")
        try:
            sock.close()
        except:
            pass
        time.sleep(2)
        sock = connect_to_server(SERVER_IP, SERVER_PORT)
